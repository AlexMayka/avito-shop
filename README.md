# **Тестовое задание для стажёра Backend-направления (зимняя волна 2025)**

## **Описание проекта**
Данный проект представляет собой **REST API** сервис для внутреннего магазина мерча в **Авито**, где сотрудники могут приобретать товары за **внутреннюю валюту — монеты (coin)**.  
Каждому новому сотруднику выделяется **1000 монет**, которые можно использовать для покупки товаров.  
Дополнительно, **монеты можно передавать другим сотрудникам** в знак благодарности или в качестве подарка.

---

## **Функциональность**
### **1️⃣ Покупка мерча**
Сотрудник может приобрести товары из магазина за монеты.

### **2️⃣ Перевод монет другим сотрудникам**
Позволяет отправлять монеты коллегам.

### **3️⃣ Просмотр истории покупок и переводов**
Пользователь может видеть:
- **Список купленных товаров**
- **Историю перемещения монет**, включая:
    - Кто передавал ему монеты и сколько
    - Кому он передавал монеты и сколько

### **4️⃣ Безопасность операций**
✅ **Запрещено** уходить в **минус** при покупках или переводах.  
✅ **Аутентификация** пользователей реализована через **JWT**.


## **📌 Магазин мерча**
В магазине доступно **10 товаров** с фиксированными ценами.

| Товар       | Цена  |
|------------|------|
| T-shirt    | 80   |
| Cup        | 20   |
| Book       | 50   |
| Pen        | 10   |
| Powerbank  | 200  |
| Hoody      | 300  |
| Umbrella   | 200  |
| Socks      | 10   |
| Wallet     | 50   |
| Pink-hoody | 500  |

📌 **Запас каждого товара бесконечен.**

---

## **📌 Технические требования**
- **Язык**: **Go**
- **Фреймворк**: **Gin**
- **База данных**: **PostgreSQL**
- **Аутентификация**: **JWT**
- **Контейнеризация**: **Docker + Docker Compose**
- **Миграции БД**: **Goose**
- **Логирование**: **logrus**
- **Тестирование**:
    - **Юнит-тесты** (покрытие бизнес-логики, **>40%**)
    - **Интеграционные / E2E тесты** (покупка мерча, передача монет)

## **📌 Установка и запуск**

### **1️⃣ Клонирование репозитория**
```bash
git clone https://github.com/your-repo/avito-coin-shop.git
cd avito-coin-shop
```

### **1️⃣ Запуск сервиса с помощью Docker**
```bash
docker-compose up --build
```

Сервис будет доступен по адресу:
```
http://localhost:8080
```

## **📌 API Эндпоинты**

### 🔐 **Аутентификация**
| Метод | URL         | Описание                         | Аутентификация |
|--------|------------|---------------------------------|---------------|
| `POST` | `/api/auth` | Авторизация / регистрация пользователя. При первом входе создается новый пользователь. | ❌ (публичный) |

---

### 🛒 **Покупка товаров**
| Метод | URL           | Описание                                  | Аутентификация |
|--------|--------------|------------------------------------------|---------------|
| `GET`  | `/api/buy/:item` | Покупка мерча. Списывает монеты и добавляет товар в инвентарь. | ✅ (требуется JWT) |

---

### 💸 **Переводы монет**
| Метод  | URL              | Описание                                    | Аутентификация |
|--------|-----------------|--------------------------------------------|---------------|
| `POST` | `/api/sendCoin` | Передача монет другому сотруднику. Нельзя отправить монеты самому себе. | ✅ (требуется JWT) |

---

### 📊 **Просмотр данных**
| Метод | URL         | Описание                                                      | Аутентификация |
|--------|------------|--------------------------------------------------------------|---------------|
| `GET`  | `/api/info` | Получение информации о пользователе: баланс, покупки, история переводов. | ✅ (требуется JWT) |


## **📌 Тестирование**

Для проверки работоспособности сервиса реализованы **юнит-тесты** (unit tests) и **интеграционные / E2E-тесты** (integration / end-to-end tests).

### **📌 Запуск всех тестов**

```bash
go test ./tests/unit_test -v
go test ./tests/e2e -v
```

## **📌 Результаты тестирования**

### ✅ **Юнит- и E2E-тесты**
Все реализованные тесты успешно **пройдены**.  
Юнит-тестирование покрывает 53%, а E2E-тесты проверяют ключевые бизнес-сценарии.

### ✅ **Результаты нагрузочного тестирования (k6)**
Сервис выдерживает нагрузку в 1000 RPS с временем ответа ≤ 50 мс в 99.99% случаев.

# **📌 Структура проекта**
Проект построен по принципу **чистой архитектуры** с разделением логики на **контроллеры, сервисы, репозитории, модели и DTO**.

```bash
.
├── README.md                   # Документация проекта
├── cmd
│   └── main.go                  # Точка входа в приложение
├── config
│   └── config.go                # Конфигурация приложения (загрузка переменных окружения)
├── deploy
│   └── Dockerfile               # Конфигурация Docker
├── docker-compose.yml           # Конфигурация сервисов Docker Compose
├── go.mod / go.sum              # Зависимости проекта
├── internal                     # Внутренний код сервиса
│   ├── controllers              # Контроллеры API (обработка запросов)
│   │   ├── auth_controller.go       # Авторизация
│   │   ├── buy_merch_controller.go  # Покупка мерча
│   │   ├── controller.go            # Базовый контроллер
│   │   ├── info_controller.go       # Получение информации о пользователе
│   │   └── send_coin_controller.go  # Перевод монет
│   ├── dto                        # Data Transfer Objects (DTO) - форматы данных API
│   │   ├── auth.go                  # DTO для аутентификации
│   │   ├── by_merch.go              # DTO для покупки мерча
│   │   ├── info.go                  # DTO для информации о пользователе
│   │   └── send_coin.go             # DTO для перевода монет
│   ├── middleware                  # Middleware (аутентификация, логирование)
│   │   ├── jwt_middleware.go        # JWT-аутентификация
│   │   └── logger_middleware.go     # Логирование запросов
│   ├── models                      # Модели данных
│   │   ├── coin_transfer_history.go # История переводов монет
│   │   ├── coin_transfers.go        # Таблица переводов монет
│   │   ├── merch.go                 # Таблица мерча
│   │   ├── purchases.go             # Таблица покупок
│   │   ├── user.go                  # Таблица пользователей
│   │   └── user_purchase.go         # Покупки пользователя
│   ├── repositories                 # Работа с базой данных
│   │   ├── coin_transfers_repositories.go # Запросы для переводов монет
│   │   ├── merch_repositories.go          # Запросы для товаров
│   │   ├── purchases_repositories.go      # Запросы для покупок
│   │   ├── querier.go                      # Интерфейс запросов к БД
│   │   └── user_repositories.go           # Запросы для пользователей
│   ├── routes                       # Маршруты API
│   │   └── routes.go                 # Определение эндпоинтов
│   ├── services                     # Бизнес-логика
│   │   ├── auth_service.go           # Логика авторизации
│   │   ├── buy_merch_service.go      # Логика покупки товаров
│   │   ├── info_service.go           # Логика получения информации о пользователе
│   │   └── send_coin_service.go      # Логика перевода монет
│   └── utils                        # Утилиты (ошибки, логи)
│       └── errors.go                 # Обработчик ошибок API
├── migrations                       # SQL-миграции для PostgreSQL
│   ├── 20250216160743_create_users_table.sql      # Создание таблицы пользователей
│   ├── 20250216160825_create_merch_table.sql      # Создание таблицы товаров
│   ├── 20250216160856_create_purchases_table.sql  # Создание таблицы покупок
│   ├── 20250216160942_create_coin_transfers_table.sql # Создание таблицы переводов
│   └── 20250216161055_insert_merch_data.sql       # Заполнение товаров (мерч)
├── pkg                              # Вспомогательные пакеты
│   ├── db
│   │   └── db.go                     # Инициализация соединения с БД
│   ├── hash_password.go              # Хеширование паролей (bcrypt)
│   ├── jwt.go                        # Генерация и проверка JWT-токенов
│   └── logger.go                     # Логирование событий через logrus
└── tests                            # Тесты
    ├── e2e                          # Интеграционные (E2E) тесты
    │   ├── auth_test.go              # Тест авторизации
    │   ├── buy_merch_test.go         # Тест покупки товара
    │   ├── send_coin_test.go         # Тест перевода монет
    │   ├── setup_test.go             # Подготовка тестовой среды
    │   ├── test_config.go            # Конфигурация тестов
    │   └── test_data.go              # Тестовые данные
    ├── loadtest.js                   # Сценарий нагрузочного тестирования (k6)
    ├── results.json                   # Результаты нагрузочного теста
    └── unit_test                     # Юнит-тесты
        ├── auth_service_test.go       # Юнит-тест аутентификации
        ├── buy_merch_service_test.go  # Юнит-тест покупки товара
        ├── jwt_test.go                # Юнит-тест JWT-токенов
        ├── mocks_test.go              # Моки для тестов
        ├── repository_test.go         # Тестирование работы с БД
        └── send_coin_service_test.go  # Юнит-тест перевода монет
```

___

## **📌 Принятые решения и решённые проблемы**

### **📌 1️⃣ Как избежать отрицательного баланса?**
🔹 **Решение:**  
Перед каждой покупкой или переводом монет выполняется проверка достаточности баланса.  
Если у пользователя **недостаточно монет**, операция отклоняется с ошибкой `not_enough_coins`.

---

### **📌 2️⃣ Как предотвратить перевод монет самому себе?**
🔹 **Решение:**  
Добавлена проверка в `SendCoinService`:  
Если **пользователь пытается отправить монеты сам себе**, возвращается ошибка `self_transfer`.

---

### **📌 3️⃣ Как обеспечить безопасность API?**
🔹 **Решение:**
- **JWT-аутентификация** защищает API, аутентифицируя каждого пользователя.
- **Middleware для проверки JWT-токена** добавлен в защищённые маршруты.
- **Обновление JWT по истечении времени** исключает постоянный доступ с одним токеном.

---

### **📌 4️⃣ Как ускорить доступ к данным?**
🔹 **Решение:**
- Добавлены **индексы** на часто используемые поля БД:
    - `users(username)`
    - `coin_transfers(from_user_id, to_user_id)`
    - `purchases(user_id, merch_id)`
- Улучшены SQL-запросы для `InfoHandler`, агрегируя данные **одним SQL-запросом** вместо множества отдельных.

---

### **📌 5️⃣ Как обеспечить масштабируемость?**
🔹 **Решение:**  
Сервис изначально **разделён на слои**:
- **Контроллеры (Controllers)** — обработка HTTP-запросов.
- **Сервисы (Services)** — бизнес-логика.
- **Репозитории (Repositories)** — взаимодействие с БД.

При необходимости можно **заменить БД, обновить API или добавить новые функции** без переписывания всего кода.

---

### **📌 6️⃣ Как тестировать систему?**
🔹 **Решение:**
- Реализованы **юнит-тесты** для бизнес-логики (покрытие > 40%).
- Добавлены **E2E-тесты** для API (работа с реальной БД).
- **Изолированные тестовые данные** (используется `shop_test`).
- Проведено **нагрузочное тестирование (k6)** для оценки производительности.

---

### **📌 7️⃣ Как упростить развертывание сервиса?**
🔹 **Решение:**
- Использован **Docker** (контейнеризация приложения и базы данных).
- **Docker Compose** автоматически запускает БД, сервис и применяет миграции.
- Миграции **Goose** управляют схемой базы данных.

---

## **📌 Возможные улучшения**

### 🔹 **1️⃣ Улучшение производительности**
- Использование **кэширования (Redis)** для частых запросов (`/api/info`).
- Оптимизация индексов и **разделение таблицы переводов монет** (горизонтальное шардингование).

---

### 🔹 **2️⃣ Добавление новых возможностей**
- **Рейтинг сотрудников** (отображение самых активных дарителей монет).
- **Система наград** (например, если сотрудник сделал **N переводов**, он получает бонусный мерч).
- **Дополнительные способы пополнения баланса** (например, выполнение задач внутри компании).

---

### 🔹 **3️⃣ Улучшение тестирования**
- **Нагрузочные тесты с Gradual Load (Step Stress)** вместо обычного `RPS 1000` (проверка постепенного увеличения нагрузки).
- **Больше E2E-тестов**: тестирование граничных случаев (`0 монет`, `максимальное количество покупок`).

---

### 🔹 **4️⃣ Улучшение логирования и мониторинга**
- Добавление **Prometheus + Grafana** для мониторинга.
- Расширенное логирование (сохранение логов в **Graylog / Loki**).
- **Трекинг действий пользователей** (например, с помощью OpenTelemetry).

---

### 🔹 **5️⃣ Улучшение API**
- Добавление **WebSocket API** для обновления баланса в реальном времени.
- Оптимизация **JWT-токенов** (например, поддержка Refresh-токенов).
- Добавление **групповых переводов монет** (несколько сотрудников могут скидываться на один подарок).

---

## **📌 Итог**
Проект уже **полностью готов к работе**, но его можно **доработать и масштабировать**.  
Основной фокус — **оптимизация производительности, улучшение тестов и расширение функционала**. 🚀  

